/*!
 *  landscape-modeler-js
 *  @version 0.0.1
 *  @author Tom Wayson <twayson@esri.com> (http://tomwayson.com)
 *
 *  A JavaScript web application for designing, running, and saving weighted overlay models using the Esri ArcGIS API for JavaScript and ArcGIS Server image services.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/_base/fx","dojo/fx","dojo/query","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/dom-attr","dojo/on","dojo/topic","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","esri/tasks/GeometryService","esri/tasks/AreasAndLengthsParameters","./Chart","dojo/text!./templates/AreaBreakdown.html","dojo/i18n!../nls/resources","dijit/form/Button","dijit/form/Select"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){return a([n,o,p],{i18n:u,templateString:t,isVisible:!1,selectedFieldName:null,dataset:null,fPolygonLayer:null,projectId:null,scenarioId:null,_geometryService:null,_settingDialog:null,constructor:function(){this.colors=[],this.selectedFieldNameValues=[],this._defaultCharts=[],this._histogramCharts={selectedType:"",charts:[]}},postCreate:function(){this.inherited(arguments),this._geometryService=new q(this.config.geometryServiceUrl),this._createButtons(),this.isVisible=!0,this.fPolygonLayer.visible&&(this.selectedFieldNameValues=this._getFieldNameValues()),this._createData(b.hitch(this,function(a){var b=this.fPolygonLayer.name+" Area",c=this.createChart({type:"Pie",header:b,dataType:"area",fPolygonLayer:this.fPolygonLayer,selectedFieldName:this.selectedFieldName},a);this._defaultCharts.push(c);var d=this.createChart({type:"Columns",header:b,dataType:"area",fPolygonLayer:this.fPolygonLayer,selectedFieldName:this.selectedFieldName},a);this._defaultCharts.push(d),this.reposition()}))},startup:function(){this.own(c.connect(this.fPolygonLayer,"onUpdateEnd",b.hitch(this,function(){this.refresh()}))),this.own(c.connect(this.fPolygonLayer,"onEditsComplete",b.hitch(this,function(){this.refresh()}))),this.own(m.subscribe(this.config.topics.MODELER_MODEL_RUN,b.hitch(this,function(){this._histogramCharts.charts.length>0&&this.refresh()})))},showModelCharts:function(a){d.forEach(this._defaultCharts,b.hitch(this,function(a,b){b===this._defaultCharts.length-1?i.add(a.domNode.parentNode,"rootLevelChart lastChart"):i.add(a.domNode.parentNode,"rootLevelChart")}));var c={colors:a.colors,dataset:a.dataset},e=a.type+" "+a.currentModelName;if(this._histogramCharts.selectedType=a.type,0===this._histogramCharts.charts.length){var f=this.createChart({type:"Pie",header:e,dataType:"count"},c);this._histogramCharts.charts.push(f);var j=this.createChart({type:"Columns",header:e,dataType:"count"},c);this._histogramCharts.charts.push(j);var k=0,l=g(".mdlrCharts li");l.forEach(b.hitch(this,function(a){k=h.get(a,"height")>k?a.clientHeight:k})),l.forEach(b.hitch(this,function(a){h.set(a,"height",k+"px")})),h.set(this.collapseButton,"display","")}else m.publish("/charts/histogram/Refreshed",this,{removedFieldValues:[],data:c,title:e})},_createButtons:function(){l(this.closeButton,"click",b.hitch(this,function(){e.fadeOut({node:this.domNode,onEnd:b.hitch(this,function(){h.set(this.domNode,"display","none"),this.isVisible=!1})}).play()})),l(this.minimizeRestoreButton,"click",b.hitch(this,function(){i.contains(this.minimizeRestoreButton,"mdlrChartsHeaderIconMinimize")&&(h.set(this.domNode,"width",this.domNode.clientWidth+"px"),f.wipeOut({node:this.mdlrCharts,onEnd:b.hitch(this,function(){i.replace(this.minimizeRestoreButton,"mdlrChartsHeaderIconRestore","mdlrChartsHeaderIconMinimize"),k.set(this.minimizeRestoreButton,"title",u.dashboard.restore)})}).play()),i.contains(this.minimizeRestoreButton,"mdlrChartsHeaderIconRestore")&&f.wipeIn({node:this.mdlrCharts,onEnd:b.hitch(this,function(){i.replace(this.minimizeRestoreButton,"mdlrChartsHeaderIconMinimize","mdlrChartsHeaderIconRestore"),h.set(this.domNode,"width","auto"),k.set(this.minimizeRestoreButton,"title",u.dashboard.minimize)})}).play()})),this.own(l(this.collapseButton,"click",b.hitch(this,function(){d.forEach(this._histogramCharts.charts,function(a){var b=a.domNode.parentNode;a.destroy(),b.parentNode.removeChild(b)}),this._histogramCharts.charts=[],d.forEach(this._defaultCharts,function(a){i.remove(a.domNode.parentNode,"rootLevelChart lastChart")});var a=g(".mdlrCharts li");a.forEach(b.hitch(this,function(a){h.set(a,"height","auto")})),this.reposition(),h.set(this.collapseButton,"display","none")})))},reposition:function(){e.animateProperty({node:this.domNode,properties:{marginLeft:{end:-this.domNode.clientWidth/2,units:"px"}}}).play()},_getFillColors:function(a){var c={};return d.forEach(this.fPolygonLayer.renderer.infos,b.hitch(this,function(b){var d=b.value,e=dojo.indexOf(a,d);e>-1&&(c[d]=b.symbol.color.toHex())})),c},_getFieldNameValues:function(){var a=[];return d.forEach(this.fPolygonLayer.graphics,b.hitch(this,function(b){var c=b.attributes[this.selectedFieldName],d=dojo.indexOf(a,c);0>d&&c&&a.push(c)})),a},_getTotalArea:function(a,c){var e=new r;e.lengthUnit=q.UNIT_KILOMETER,e.areaUnit=q.UNIT_ACRES,e.calculationType="preserveShape";var f=[];d.forEach(a,function(a){f.push(a.geometry)}),this._geometryService.simplify(f,b.hitch(this,function(b){e.polygons=b,this._geometryService.areasAndLengths(e,function(b){dojo.forEach(b.areas,function(b,c){a[c].area=b}),c&&c(a)},function(a){console.out("Error: ",a)})}))},_createData:function(a){var c;this.fPolygonLayer&&this.fPolygonLayer._map&&(c=this.fPolygonLayer._map.extent),this.dataset=d.map(this.selectedFieldNameValues,b.hitch(this,function(a){return{name:a,value:0}}));var e=[];this.colors=this._getFillColors(this.selectedFieldNameValues);var f=!1;this.fPolygonLayer.visible&&this.dataset.length>0?(d.forEach(this.fPolygonLayer.graphics,b.hitch(this,function(a){var b=a.attributes[this.selectedFieldName],d=dojo.indexOf(this.selectedFieldNameValues,b);d>-1&&c&&c.contains(a.geometry.getExtent())&&(e.push({name:b,geometry:a.geometry,area:0}),f||(f=!f))})),this._getTotalArea(e,b.hitch(this,function(){d.forEach(e,b.hitch(this,function(a){var b=a.name;d.forEach(this.dataset,function(c){c.name===b&&(c.value+=a.area)})})),f?a({colors:this.colors,dataset:this.dataset}):a(null)}))):a(null),this.featureCountNode.innerHTML=e.length},createChart:function(a,b){var c=this,d=j.create("li",null,this.mdlrCharts),e=j.create("div",null,d),f=new s({type:a.type,header:a.header,keyType:a.keyType?a.keyType:null,data:b,dataType:a.dataType,fPolygonLayer:a.fPolygonLayer,selectedFieldName:a.selectedFieldName},e);return this.reposition(),this.own(f.on("type-select",function(a){m.publish(c.config.topics.CHART_FEATURETYPE_SELECTED,c,a)})),f},refresh:function(){if(this.isVisible){var a=this.selectedFieldNameValues;this.selectedFieldNameValues=this._getFieldNameValues();var c=[];if(d.forEach(a,b.hitch(this,function(a){var b=dojo.indexOf(this.selectedFieldNameValues,a);0>b&&c.push(a)})),this._createData(b.hitch(this,function(a){m.publish("/charts/area/Refreshed",this,{removedFieldValues:c,data:a})})),this._histogramCharts.charts.length>0){var e=[],f=this.fPolygonLayer,g=this._histogramCharts.selectedType;d.forEach(f.graphics,b.hitch(this,function(a){a.attributes[this.selectedFieldName]===g&&e.push(a.geometry)})),m.publish(this.config.topics.CHART_FEATURETYPE_SELECTED,this,{type:g,geometries:e})}}},show:function(){this.isVisible=!0,h.set(this.domNode,"display",""),e.fadeIn({node:this.domNode}).play()}})});