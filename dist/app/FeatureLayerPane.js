/*!
 *  landscape-modeler-js
 *  @version 0.1.0
 *  @author Tom Wayson <twayson@esri.com> (http://tomwayson.com)
 *
 *  A web application for designing, running, and saving weighted overlay models using the Esri ArcGIS API for JavaScript and ArcGIS Server image services.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/Evented","dojo/dom-construct","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","esri/layers/FeatureLayer","esri/dijit/Legend","esri/dijit/editing/Editor","esri/dijit/editing/TemplatePicker","./reports/AreaBreakdown","dojo/text!./templates/FeatureLayerPane.html","dojo/i18n!./nls/resources","dijit/TitlePane","dijit/Dialog","dijit/form/Button","dijit/form/ValidationTextBox","dijit/form/HorizontalSlider","dojo/parser","dojox/validate/regexp"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return a([g,h,i,e],{templateString:o,i18n:p,baseClass:"mdlrFeatureLayerPane",featureLayerUrl:"",typeField:"",_setMapAttr:function(a){var b=this;this.map=a,this.own(this.map.on("layer-add-result",function(a){b.featureLayer&&a.layer&&a.layer.id===b.featureLayer.id&&(a.error||b._intit())}))},postCreate:function(){var a=this;this.inherited(arguments),this.own(d(this.featureLayerUrlNode,"Change",function(){var b=a.loadButtonNode;b.set("disabled",!a.featureLayerUrlNode.isValid()),b.focus()})),this.own(d(this.visibilityNode,"change",function(){a.setVisibility(this.checked)})),this.own(d(this.transparencyNode,"Change",function(){a.setTransparency(this.value)}))},setVisibility:function(a){this.visibilityNode.checked!==a&&(this.visibilityNode.checked=a),this.featureLayer&&(this.visibilityNode.checked?this.featureLayer.show():this.featureLayer.hide())},setTransparency:function(a){a>=0&&1>=a&&(this.transparencyNode.value!==a&&this.transparencyNode.set("value",a),this.featureLayer&&(this.featureLayer.setOpacity(1-a),this.legend&&this.legend.refresh()))},_intit:function(){var a=this.featureLayer;a&&(this.setVisibility(!0),this.nameNode.innerHTML=a.name,document.querySelector(".mdlrFeatureLayerVisibility").style.display="",this.removeFeaturesButton.set("disabled",!1),"esriGeometryPolygon"===a.geometryType&&a.renderer.attributeField&&"esri.renderer.UniqueValueRenderer"===a.renderer.declaredClass?(this.typeField=a.renderer.attributeField,this.showChartsButtonNode.set("disabled",!1),this.showChartsButtonNode.set("title",""),a.isEditable()?(a.types&&a.typeIdField&&a.types.sort&&a.types.sort(function(a,b){return a.name>b.name}),this._showTemplatePicker(),this._showEditor()):this._initLegend()):(this.typeField=null,this.showChartsButtonNode.set("disabled",!0),this.showChartsButtonNode.set("title","Charts are only available for polygon feature layers with unique value renderers"),this._initLegend()))},_destroyLayerControls:function(){document.querySelector(".mdlrFeatureLayerVisibility").style.display="none",this.nameNode.innerHTML="",this.legend&&(this.legend.destroy(),this.legend=null),this.editor&&(this.editor.destroy(),this.editor=null),this.templatePicker&&(this.templatePicker.destroy(),this.templatePicker=null),this.chartPane&&(this.chartPane.destroy(),this.chartPane=null)},_initLegend:function(){var a=this.featureLayer;a&&(this.legend=new k({map:this.map,layerInfos:[{layer:a,title:""}]},f.create("div",null,this.legendNode,"only")),this.legend.startup())},_onLoadFeaturesClick:function(){this.loadDialog.show()},_showCharts:function(){this.typeField&&(this.chartPane&&(this.chartPane.destroy(),this.chartPane=null),this.chartPane=new n({config:this.config,fPolygonLayer:this.featureLayer,selectedFieldName:this.featureLayer.renderer.attributeField},f.create("div",null,this.chartPaneNode)),this.chartPane.startup(),this.chartPane.show())},_onCancelClick:function(){this.loadDialog.hide()},_onLoadClick:function(){this.featureLayerUrlNode.isValid()&&(this.setFeatureLayerUrl(this.featureLayerUrlNode.value),this.loadDialog.hide())},setFeatureLayerUrl:function(a){var b=this.map,c={id:"featureLayer",mode:j.MODE_ONDEMAND,outFields:["*"],visible:this.visibilityNode.checked,opacity:1-this.transparencyNode.value};a&&(this.removeFeatureLayer(),this.emit("layer-load-start",{url:a,options:c}),this.featureLayer=new j(a,c),b.addLayer(this.featureLayer))},_showTemplatePicker:function(){var a=f.create("div",null,this.templatePickerNode,"only");this.templatePicker=new m({featureLayers:[this.featureLayer],grouping:!0,rows:"auto",columns:3},a),this.templatePicker.startup()},_showEditor:function(){var a=f.create("div",null,this.editorNode,"only"),b={map:this.map,templatePicker:this.templatePicker,layerInfos:[{featureLayer:this.featureLayer}],geometryService:this.config.geometryServiceUrl,toolbarVisible:!0,createOptions:{polylineDrawTools:[l.CREATE_TOOL_FREEHAND_POLYLINE],polygonDrawTools:[l.CREATE_TOOL_FREEHAND_POLYGON]},toolbarOptions:{}};this.editor=new l({settings:b},a),this.editor.startup()},_onRemoveFeaturesClick:function(){this.removeFeatureLayer()},removeFeatureLayer:function(){var a;this.featureLayer&&(this.map&&(a=this.map.getLayer(this.featureLayer.id),a&&this.map.removeLayer(a)),this._destroyLayerControls(),this.showChartsButtonNode.set("disabled",!0),this.removeFeaturesButton.set("disabled",!0),this.typeField="",this.featureLayer=null)}})});