/*!
 *  landscape-modeler-js
 *  @version 0.0.1
 *  @author Tom Wayson <twayson@esri.com> (http://tomwayson.com)
 *
 *  A JavaScript web application for designing, running, and saving weighted overlay models using the Esri ArcGIS API for JavaScript and ArcGIS Server image services.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/Evented","dojo/topic","dojo/dom","dojo/dom-construct","dojo/dom-attr","dojo/Deferred","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/form/Button","esri/layers/ArcGISImageServiceLayer","esri/geometry/Extent","esri/tasks/GeometryService","esri/tasks/ProjectParameters","esri/domUtils","modeler/WeightedOverlayService","modeler/widget/WeightedOverlayLayersSelector","modeler/widget/WeightedOverlayModelDesigner","./geometryUtils","./portal/PortalControls","./reports/chartUtils","dojo/text!./templates/ModelerPane.html","dojo/i18n!./nls/resources","dijit/form/Button"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){return a([k,l,m,e],{templateString:z,i18n:A,baseClass:"mdlrAppPane",_setPortalUserAttr:function(a){this.portalUser=a,this.userNameNode.innerHTML=this.portalUser.fullName,this.portalControls&&this.portal.set&&this.portalControls.set("portal",this.portalUser.portal)},postCreate:function(){this.inherited(arguments),this.appTitleNode.innerHTML=this.config.appTitle,document.title=this.config.appTitle,i.set(this.helpLink,"href",this.config.helpUrl),this._geometryService=new q(this.config.geometryServiceUrl)},startup:function(){this.inherited(arguments);var a=this;this.weightedOverlayService=new t(new o(this.config.weightedOverlayService.url),this.config.weightedOverlayService.options),this.own(this.weightedOverlayService.imageServiceLayer.on("load",function(b){a.weightedOverlayServiceSR=b.layer.spatialReference})),this.weightedOverlayModel=this.weightedOverlayService.createNewModel(),this.weightedOverlayService.initRasterLayers().then(function(){a._init()})},_init:function(){var a=this;this.portalControls=new x(b.mixin(this.config.portalOptions,{map:this.map,portal:this.portalUser.portal,weightedOverlayService:this.weightedOverlayService}),this.portalControlsNode),this.portalControls.startup(),this.portalControls.on("item-loaded",function(b){a.modelItemLoaded(b)}),this.portalControls.startup(),this.selectLayersView=new u({model:this.weightedOverlayModel,weightedOverlayService:this.weightedOverlayService,map:this.map,previewLayerOptions:{id:"preview",visible:!1}},this.selectLayersNode),this.selectLayersView.startup(),this.designModelView=new v({model:this.weightedOverlayModel,weightedOverlayService:this.weightedOverlayService},this.designModelNode),this.designModelView.startup(),this.own(d(this.designModelView,"model-run",function(b){a.portalControls.set("model",b),a.selectLayersView.hidePreviewLayer(),f.publish(a.config.topics.MODELER_MODEL_RUN,a,b)})),this.map.addLayer(this.weightedOverlayService.imageServiceLayer),f.subscribe(this.config.topics.CHART_FEATURETYPE_SELECTED,function(b,c){var d={type:c.type,currentModelName:a.portalControls?a.portalControls.getTitle():""};c.geometries.length>0&&a.getChartData(c.geometries).then(function(a){d.dataset=a.dataset,d.colors=a.colors,b.showModelCharts(d)})}),this.config.modelItemId&&this.portalControls.loadModelItem(this.config.modelItemId)},showSelectOverlayLayersView:function(){s.hide(this.designModelViewNode),s.show(this.selectLayersViewNode)},showDesignModelView:function(){this.designModelView.set("model",this.weightedOverlayModel),s.hide(this.selectLayersViewNode),s.show(this.designModelViewNode)},modelItemLoaded:function(a){var b=a.itemData;b&&(b.operationalLayers?(this.weightedOverlayModel=this.weightedOverlayService.operationalLayersToModel(b.operationalLayers),b.mapOptions&&b.mapOptions.extent&&this.map.setExtent(new p(b.mapOptions.extent))):this.weightedOverlayModel=this.weightedOverlayService.imageServiceLayerToModel(b),this.selectLayersView.set("model",this.weightedOverlayModel),this.showDesignModelView(),this.designModelView.runModel())},getChartData:function(a){var b=this;return this.getModelPixelSize({forceSquare:!0}).then(function(d){var e=w.createMergedPolygon(a,a[0].spatialReference);return b.weightedOverlayService.getHistogram(b.weightedOverlayModel,e,{pixelSize:d}).then(function(a){var e;return e=b.config&&b.config.areaUnit&&b.config.areaUnit.conversionFactor>0?b.config.areaUnit.conversionFactor:1,a.counts=c.map(a.counts,function(a){return a*d.x*d.y*e}),y.getChartData(b.weightedOverlayModel.colormapDefinition,a)})})},getModelPixelSize:function(a){var c,d,e,f=this;return this.weightedOverlayService&&this.weightedOverlayService.imageServiceLayer&&this.weightedOverlayService.imageServiceLayer.spatialReference&&this.map&&this.map.extent?(e=b.mixin(a,{width:f.map.width,height:f.map.height}),this.map.extent.spatialReference.wkid!==this.weightedOverlayService.imageServiceLayer.spatialReference.wkid?(c=new r,c.geometries=[this.map.extent],c.outSR=this.weightedOverlayService.imageServiceLayer.spatialReference,this._geometryService.project(c).then(function(a){return f.weightedOverlayService.getModelPixelSize(a[0],e)})):(d=new j,d.resolve(this.weightedOverlayService.getModelPixelSize(this.map.extent,e)),d)):(d=new j,d.reject("Map or image service not initialized"),d)},_onDesignModelButtonClick:function(){this.showDesignModelView()},_onSelectLayersButtonClick:function(){this.showSelectOverlayLayersView()},_onLogOutClick:function(a){a.preventDefault(),f.publish(this.config.topics.MODELER_SIGNOUT)}})});