/*!
 *  landscape-modeler-js
 *  @version 0.0.1
 *  @author Tom Wayson <twayson@esri.com> (http://tomwayson.com)
 *
 *  A JavaScript web application for designing, running, and saving weighted overlay models using the Esri ArcGIS API for JavaScript and ArcGIS Server image services.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/Evented","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_Container","dijit/TooltipDialog","dijit/popup","esri/IdentityManager","esri/request","esri/layers/ArcGISImageServiceLayer","./containerUtils","dojo/text!./templates/WeightedOverlayLayerSelector.html","dijit/form/HorizontalSlider","dijit/form/Button"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=0,s=function(a,b,c){var d=a.getLayer(c.id);if(d){if(d.url===b)return d;a.removeLayer(d)}var e=new n(b,c);return a.addLayer(e)},t=function(a){var b=a+"/info/iteminfo";return m({url:b,content:{f:"json"},handleAs:"json",callbackParamName:"callback"})},u=a([f,g,h,e],{templateString:p,baseClass:"weighted-overlay-layer-selector",_setRasterLayerAttr:function(a){this.chkModelLayer.setAttribute("value",a.id.toString()),this.chkModelLayer.setAttribute("title",a.title),this.txtLabel.innerHTML=a.title},_setTooltipDialogAttr:function(a){var b=this;this.tooltipDialog=a,this.own(d(a,"MouseLeave",function(){k.close(b.tooltipDialog)}))},postCreate:function(){var a=this,b=this.chkModelLayer,c=this.btnInfo;b.id=b.name+"_"+r++,this.txtLabel.setAttribute("for",b.id),this.showPreview&&this.rasterLayer.url?this.own(d(this.btnPreview,"click",function(){a.emit("PreviewClick",a.rasterLayer.url,a.btnPreview)})):(this.btnPreview.style||(this.btnPreview.style={}),this.btnPreview.set("style",{display:"none"})),this.showInfo&&this.rasterLayer.url?this.own(d(c,"click",function(){a.showInfoTooltip()})):this.btnInfo.set("style",{display:"none"})},showInfoTooltip:function(){var a=this;this.rasterLayer&&this.rasterLayer.infoText?this._showInfoTooltip(this.rasterLayer.infoText):this.rasterLayer.url&&t(this.rasterLayer.url).then(function(b){a.rasterLayer.infoText=b.snippet||b.summary||b.description,a._showInfoTooltip(a.rasterLayer.infoText)})},_showInfoTooltip:function(a){var b,c;this.tooltipDialog&&(k.close(this.tooltipDialog),b=this.rasterLayer.url,c=l.findCredential(b),c&&c.token&&(b+=(b.indexOf("?")>-1?"&":"?")+"token="+c.token),a+=" <a href="+b+" target='_blank'>Read More</a>",this.tooltipDialog.set("content",a),k.open({popup:this.tooltipDialog,around:this.btnInfo.domNode,orient:["after-centered","after"]}))},setSelected:function(a){this.chkModelLayer.checked=a}});return a([f,i,e],{showPreview:!0,showInfo:!0,_setWeightedOverlayServiceAttr:function(a){this.setWeightedOverlayService(a)},_setModelAttr:function(a){this.setModel(a)},buildRendering:function(){this.inherited(arguments);var a=document.createElement("div"),b=document.createElement("label");b.innerHTML="Transparency:",a.appendChild(b),this.domNode.appendChild(a),this.previewSlider=new q({minimum:0,maximum:1,value:.2,intermediateChanges:!0,showButtons:!1,"class":"modeler-transparency-slider"}),this.previewSlider.placeAt(a,"last"),this.containerNode=document.createElement("div"),this.containerNode.setAttribute("class","modeler-scroll-panel"),this.domNode.appendChild(this.containerNode),this.tooltipDialog=new j({style:"width: 300px;"})},postCreate:function(){var a=this;this.own(d(this.containerNode,"change",function(b){a._onContainerNodeChange(b)})),this.own(d(this.previewSlider,"change",function(){a.updatePreviewOpacity()}))},_onContainerNodeChange:function(a){var b,c,d=a.target;if("checkbox"===d.type)if(b=this._getLayerIdFromCheckbox(d),d.checked){c=this.getOverlayLayer(b);try{this.addOverlayLayer(c||{id:b,weight:0})}catch(e){this._showError(e),a.target.checked=!1}}else this.removeOverlayLayer(b)},_getLayerIdFromCheckbox:function(a){var b;try{b=parseInt(a.value,10)}catch(c){b=a.value}return b},_showError:function(a){window.alert(a)},setWeightedOverlayService:function(a){var b=this;this.weightedOverlayService=a,o.removeChildren(this),c.forEach(this.weightedOverlayService.rasterLayers,function(a){var c=b.getOverlayLayer(a.id),e=new u({rasterLayer:a,tooltipDialog:b.tooltipDialog,showPreview:b.showPreview,showInfo:b.showInfo});e.setSelected(c?!0:!1),e.startup(),this.own(d(e,"PreviewClick",function(a,c){b._OnPreviewClick(a,c)})),b.addChild(e)},this)},setModel:function(a){this.model=a;var b=this.containerNode.querySelectorAll('input[name="selectedLayers"]');c.forEach(b,function(a){var b=this._getLayerIdFromCheckbox(a);a.checked=c.some(this.model.overlayLayers,function(a){return a.id===b})},this)},_OnPreviewClick:function(a,b){var c=this;a&&(this._selectedPreviewNode&&c._previewLayer&&c._previewLayer.url===a?c.hidePreviewLayer():(c._setPreviewLayer(a),c._setSelectedPreviewNode(b)))},hidePreviewLayer:function(){this._previewLayer&&this._previewLayer.hide(),this._selectedPreviewNode&&(this._selectedPreviewNode.set("iconClass","icon-globe"),this._selectedPreviewNode=null)},_setPreviewLayer:function(a){var c=b.mixin({id:"preview"},this.previewLayerOptions);this._previewLayer=s(this.map,a,c),this.updatePreviewOpacity(),this._previewLayer.show()},updatePreviewOpacity:function(){this._previewLayer&&this._previewLayer.setOpacity(1-this.previewSlider.value)},showPreviewLayer:function(){this._previewLayer&&this._previewLayer.show()},_setSelectedPreviewNode:function(a){this._selectedPreviewNode&&this._selectedPreviewNode.set("iconClass","icon-globe"),this._selectedPreviewNode=a,a.set("iconClass","icon-globe icon-white")},addOverlayLayer:function(a){var b,c;if(!this.weightedOverlayService)throw"No weighted overlay service defined for model.";if(b=this.weightedOverlayService.rastersInFunction,!(this.model.overlayLayers.length<b)&&b)throw"Maximum of "+b+" layers allowed by service, you must first remove a layer before adding a new one.";if(c=this.weightedOverlayService.getRasterLayer(a.id),!c)throw"Layer "+a.id+" not found in weighted overlay service";a.name=c.name,a.url=c.url,a.title=c.title,a.remapRanges||(a.remapRanges=c.remapRanges),this.removeOverlayLayer(a.id),this.model.overlayLayers.push(a)},getOverlayLayer:function(a){var b;return c.some(this.model.overlayLayers,function(c){return c.id===a?(b=c,!1):void 0}),b},removeOverlayLayer:function(a){for(var b=this.model.overlayLayers,c=b.length,d=0;c>d;d++)if(b[d].id===a){b.splice(d,1);break}}})});