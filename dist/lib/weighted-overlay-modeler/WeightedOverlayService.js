/*!
 *  landscape-modeler-js
 *  @version 0.1.0
 *  @author Tom Wayson <twayson@esri.com> (http://tomwayson.com)
 *
 *  A web application for designing, running, and saving weighted overlay models using the Esri ArcGIS API for JavaScript and ArcGIS Server image services.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/string","dojo/number","esri/request","esri/layers/RasterFunction"],function(a,b,c,d,e,f,g){var h=function(a,b){var c;if(!a||!b)return!1;if(c=a.length,c!==b.length)return!1;for(var d=0;c>d;d++)if(a[d]instanceof Array&&b[d]instanceof Array){if(!a[d].compare(b[d]))return!1}else if(a[d]!==b[d])return!1;return!0},i=function(a){var b,d,e,f,g,h,i=a.attributes;return i&&(h={id:i.OBJECTID,name:i.Name,title:i.Title,url:i.Url},i.InputRanges&&i.InputRanges.split&&i.OutputValues&&i.OutputValues.split&&(b=c.map(i.InputRanges.split(","),function(a){return parseInt(a.trim(),10)}),d=c.map(i.OutputValues.split(","),function(a){return parseInt(a.trim(),10)}),i.RangeLabels&&i.RangeLabels.split&&(f=c.map(i.RangeLabels.split(","),function(a){return a.trim()}))),i.NoDataRanges&&i.NoDataRanges.split&&(e=c.map(i.NoDataRanges.split(","),function(a){return parseInt(a.trim(),10)}),i.NoDataRangeLabels&&i.NoDataRangeLabels.split&&(g=c.map(i.NoDataRangeLabels.split(","),function(a){return a.trim()}))),h.remapRanges=m.createRemapRanges(b,d,e,{labels:f,noDataLabels:g})),h},j=function(a){return c.map(a.colors,function(a){return[a.value].concat(a.rgb)})},k=function(a){var b=[],d=0;return a&&a.overlayLayers&&a.overlayLayers.push?a.overlayLayers.length>0?(c.forEach(a.overlayLayers,function(a,e){d+=a.weight,a.remapRanges&&a.remapRanges.push&&a.remapRanges.length>0?c.forEach(a.remapRanges,function(a,c){(isNaN(a.outputValue)||null===a.outputValue)&&b.push("Overlay layer ["+e+"] remap ranges ["+c+"] output value missing or invalid"),(isNaN(a.inputMin)||null===a.inputMin||isNaN(a.inputMax)||null===a.inputMax||a.inputMin>a.inputMax)&&b.push("Overlay layer ["+e+"] remap ranges ["+c+"] input min/max missing or invalid")}):b.push("Overlay layer ["+e+"] missing remap ranges")}),100!==d&&b.push("Overlay layer weights must add up to 100")):b.push("At least one overlay layer is required"):b.push("Overlay layers is not defined"),b},l=function(a,b,c){var d=a+"/computeHistograms",e={geometryType:"esriGeometryPolygon",f:"json"};return e.geometry=JSON.stringify(b),c&&(c.renderingRule&&(e.renderingRule=JSON.stringify(c.renderingRule)),c.pixelSize&&(e.pixelSize=JSON.stringify(c.pixelSize))),f({url:d,content:e,handleAs:"json",callbackParamName:"callback"})},m={rasterFunctionArgumentsToRemapRanges:function(a,c){var d,e,f,g,h,i,j;return a&&(e=b.mixin({inputRangesArgumentName:"InputRanges",outputValuesArgumentName:"OutputValues",noDataRangesArgumentName:"NoDataRanges",labelsArgumentName:"Labels",noDataLabelsArgumentName:"NoDataLabels"},c),f=a[e.inputRangesArgumentName],g=a[e.outputValuesArgumentName],h=a[e.noDataRangesArgumentName],i=a[e.labelsArgumentName],j=a[e.noDataLabelsArgumentName],d=this.createRemapRanges(f,g,h,{labels:i,noDataLabels:j})),d},createRemapRanges:function(a,b,d,e){var f,g,h=[],i=!1;return e&&(f=e.labels,g=e.noDataLabels),a&&a.push&&b&&b.push&&a.length===2*b.length&&(i=f&&f.push&&f.length===b.length,c.forEach(b,function(b,c){var d=2*c,e={inputMin:a[d],inputMax:a[d+1],outputValue:b};e.label=i?f[c]:this.getRangeString(e.inputMin,e.inputMax),h.push(e)},this)),d&&d.push&&d.length>0&&(i=g&&g.push&&g.length===d.length/2,c.forEach(d,function(a,b){if(0===b%2){var c={inputMin:a,inputMax:d[b+1],outputValue:0};c.label=i?g[b]:this.getRangeString(c.inputMin,c.inputMax),h.push(c)}},this)),h.length>0?h:void 0},getRangeString:function(a,b){return a===b?a+"":a+" - "+b},remapRangesToRasterFunctionArguments:function(a,d){var e,f,g,h,i,j,k;return a&&(e={},f=b.mixin({includeLabels:!0,inputRangesArgumentName:"InputRanges",outputValuesArgumentName:"OutputValues",noDataRangesArgumentName:"NoDataRanges",labelsArgumentName:"Labels",noDataLabelsArgumentName:"NoDataLabels"},d),g=[],h=[],i=[],j=[],k=[],c.forEach(a,function(a){var b=a.label||this.getRangeString(a.inputMin,a.inputMax);a.outputValue?(g.push(a.inputMin),g.push(a.inputMax),h.push(a.outputValue),j.push(b)):(i.push(a.inputMin),i.push(a.inputMax),k.push(b))},this),h.length>0&&(e[f.inputRangesArgumentName]=g,e[f.outputValuesArgumentName]=h,f.includeLabels&&(e[f.labelsArgumentName]=j)),i.length>0&&(e[f.noDataRangesArgumentName]=i,f.includeLabels&&(e[f.noDataLabelsArgumentName]=k))),e},getRemapRangeByValue:function(a,b){var d;return(b||0===b)&&c.some(a,function(a){return b===a.inputMin&&b===a.inputMax||b>=a.inputMin&&b<a.inputMax?(d=a,!0):!1}),d}};return a([],{constructor:function(a,c){var d=c||{};this.imageServiceLayer=a,this.rasterFunctionName=d.rasterFunctionName||"",this.histogramRasterFunctionName=d.histogramRasterFunctionName||"",this.rastersInFunction=d.rastersInFunction||0,this.variableName=d.variableName||"Raster",this.colorMapArgName=d.colorMapArgName||"Colormap",this.dummyRasterId=d.dummyRasterId||1,this.colormapDefinitions=d.colormapDefinitions||[],this.argumentNamePrefixes=b.mixin({id:"Raster",weight:"Weight_Raster",inputRanges:"InputRanges_Raster",outputValues:"OutputValues_Raster",noDataRanges:"NoDataRanges_Raster",labels:"Labels_Raster",noDataLabels:"NoDataLabels"},d.argumentNamePrefixes),this.queryParameters=b.mixin({where:"1=1",outFields:["*"],returnGeometry:!1},d.queryParameters),this.rasterLayers=d.rasterLayers||[]},initRasterLayers:function(a){var b=this,d=a||function(a,b){return a.attributes.Title<b.attributes.Title?-1:a.attributes.Title>b.attributes.Title?1:0};return this.queryRasters().then(function(a){var e,f=a.features;return f&&f.length&&f.length>0&&f[0].attributes&&(b.rasterLayers&&b.rasterLayers.push?b.rasterLayers.length=0:b.rasterLayers=[],d&&f.sort(d),c.forEach(f,function(a){e=i(a),e&&b.rasterLayers.push(e)})),b.rasterLayers})},queryRasters:function(a){var c=this.imageServiceLayer.url+"/query",d=b.mixin(this.queryParameters,a,{f:"json"});return d.outFields&&d.outFields.join&&(d.outFields=d.outFields.join(",")),f({url:c,content:d,handleAs:"json",callbackParamName:"callback"})},createNewModel:function(){var a={overlayLayers:[]};return this.colormapDefinitions&&this.colormapDefinitions instanceof Array&&this.colormapDefinitions.length>0&&(a.colormapDefinition=this.colormapDefinitions[0]),a},getRasterLayer:function(a){var b;return c.some(this.rasterLayers,function(c){return c.id===a?(b=c,!1):void 0}),b},operationalLayersToModel:function(a){var b;return this.rasterFunctionName&&c.some(a,function(a){return a.renderingRule&&a.renderingRule&&a.renderingRule.rasterFunction===this.rasterFunctionName?(b=a,!0):!1},this),this.imageServiceLayerToModel(b)},imageServiceLayerToModel:function(a){var c,d,e,f,g;if(a){c={overlayLayers:[]},e=new RegExp("^"+this.argumentNamePrefixes.id+"[1-9]+$"),f=a.renderingRule.rasterFunctionArguments,a.remapRangeLabels&&b.mixin(f,a.remapRangeLabels),a.noDataRangeLabels&&b.mixin(f,a.noDataRangeLabels);for(var h in f)h.match(e)?(g=h.replace(this.argumentNamePrefixes.id,""),d={id:parseInt(f[h].replace("$",""),10)},d.weight=f[this.argumentNamePrefixes.weight+g],d.weight&&d.weight>0&&(d.weight=100*d.weight,d=b.mixin(this.getRasterLayer(d.id)||{},d),d.remapRanges=m.rasterFunctionArgumentsToRemapRanges(f,{inputRangesArgumentName:this.argumentNamePrefixes.inputRanges+g,outputValuesArgumentName:this.argumentNamePrefixes.outputValues+g,noDataRangesArgumentName:this.argumentNamePrefixes.noDataRanges+g,labelsArgumentName:this.argumentNamePrefixes.labels+g,noDataLabelsArgumentName:this.argumentNamePrefixes.noDataLabels+g}),c.overlayLayers.push(d))):h===this.colorMapArgName&&(c.colormapDefinition=this.findColormapDefinition(f[h]))}return c},findColormapDefinition:function(a){var b;return c.some(this.colormapDefinitions,function(d){var e=!1;return e=c.every(d.colors,function(b,c){return h([b.value].concat(b.rgb),a[c])}),e?(b=d,!0):!1}),b},modelToOperationalLayers:function(a,b){var c=this.modelToImageServiceLayer(a,b);return[c]},modelToImageServiceLayer:function(a,b){var c={id:this.imageServiceLayer.id,url:this.imageServiceLayer.url,opacity:this.imageServiceLayer.opacity,title:"Weighted Overlay Model"},d=this.getRasterFunction(a.overlayLayers,a.colormapDefinition,{includeLabels:!0}),e={},f={};for(var g in d.arguments)0===g.indexOf(this.argumentNamePrefixes.labels)?(e[g]=d.arguments[g],delete d.arguments[g]):0===g.indexOf(this.argumentNamePrefixes.noDataLabels)&&(f[g]=d.arguments[g],delete d.arguments[g]);return c.renderingRule=d.toJson(),c.remapRangeLabels=e,c.noDataRangeLabels=f,b&&b.modelTitle&&(c.title=b.modelTitle),c},getRasterFunction:function(a,c,d){var f,h,i,k=new g,l=a.length,n={},o=b.mixin({rasterFunctionName:this.rasterFunctionName,rastersInFunction:this.rastersInFunction,argumentNamePrefixes:this.argumentNamePrefixes,variableName:this.variableName,dummyRasterId:this.dummyRasterId,includeLabels:!1},d);k.functionName=o.rasterFunctionName,o.variableName&&(k.variableName=o.variableName);for(var p=1;p<=o.rastersInFunction;p++)h=l>=p?a[p-1]:{id:o.dummyRasterId,weight:0},n[o.argumentNamePrefixes.id+p]="$"+h.id,n[o.argumentNamePrefixes.weight+p]=e.round(h.weight/100,2),h.weight>0&&h.remapRanges&&(f=m.remapRangesToRasterFunctionArguments(h.remapRanges,{includeLabels:o.includeLabels,inputRangesArgumentName:o.argumentNamePrefixes.inputRanges+p,outputValuesArgumentName:o.argumentNamePrefixes.outputValues+p,noDataRangesArgumentName:o.argumentNamePrefixes.noDataRanges+p,labelsArgumentName:o.argumentNamePrefixes.labels+p,noDataLabelsArgumentName:o.argumentNamePrefixes.noDataLabels+p}),b.mixin(n,f));if(this.colorMapArgName){if(c&&(i=j(c)),!i)throw"This raster function requires a colormap, but the model does not have a valid colormap definition";n[this.colorMapArgName]=i}return k.arguments=n,k},validateModel:function(a){var b=k(a);return{isValid:b.length<1,modelErrors:b}},runModel:function(a){var b;if(!this.imageServiceLayer)throw"Image service layer is not defined";if(b=k(a),!(b.length<1))throw"Model is not valid:\n\n"+b.join("\n");this.imageServiceLayer.setRenderingRule(this.getRasterFunction(a.overlayLayers,a.colormapDefinition))},getHistogram:function(a,c,d){var e,f=b.mixin({},d);if(this.histogramRasterFunctionName){if(this.imageServiceLayer){if(e=k(a),e.length<1)return f.renderingRule=this.getRasterFunction(a.overlayLayers,a.colormapDefinition,{rasterFunctionName:this.histogramRasterFunctionName}).toJson(),l(this.imageServiceLayer.url,c,f).then(function(a){return a.histograms[0]});throw"Model is not valid:\n\n"+e.join("\n")}throw"Image service layer is not defined"}throw"No weighted overlay histogram function defined."},getModelPixelSize:function(a,c){var d,e=this.imageServiceLayer,f=b.mixin({width:e.maxImageWidth,height:e.maxImageHeight},c),g=Math.max(e.pixelSizeX,Math.ceil(a.getWidth()/f.width)),h=Math.max(e.pixelSizeY,Math.ceil(a.getHeight()/f.height));return f.forceSquare?(d={x:Math.max(g,h)},d.y=d.x):d={x:g,y:h},d},getColormapDefinition:function(a){var b;return c.some(this.colormapDefinitions,function(c){return c.id===a?(b=c,!1):void 0}),b}})});